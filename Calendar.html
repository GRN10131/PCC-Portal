<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Interactive Calendar — Create Events</title>
<style>
/* --- (Your CSS from before, unchanged) --- */
:root{
  --bg:#0f1724;
  --card:#0b1220;
  --accent:#4f46e5;
  --muted:#94a3b8;
  --white:#e6eef8;
  --red:#ef4444;
  --radius:12px;
}
/* ...rest of your CSS... */
</style>
</head>
<body>
<div class="wrap">
  <!-- ... Your header, controls, main calendar, side panel, modal ... -->
  <!-- Copy your existing HTML for calendar grid, side panel, modal here -->
</div>

<script>
(() => {
  /*** Utility functions ***/
  const $ = sel => document.querySelector(sel);
  const qs = sel => document.querySelectorAll(sel);

  function formatISODate(d){
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  }

  function formatMonthYear(date){
    return date.toLocaleString(undefined,{month:'long', year:'numeric'});
  }

  function friendlyDateISO(iso){
    const d = new Date(iso + "T00:00:00");
    return d.toLocaleDateString(undefined,{weekday:'short', month:'short', day:'numeric'});
  }

  function escapeHtml(str){
    if(!str) return '';
    return str.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  /*** State ***/
  let viewDate = new Date();
  let selectedDateISO = formatISODate(new Date());
  const STORAGE_KEY = 'calendar_events_v1';
  const API_URL = "PASTE_POWER_AUTOMATE_HTTP_URL_HERE"; // <-- Replace with your API URL

  /*** DOM refs ***/
  const monthLabel = $('#monthLabel');
  const grid = $('#calendarGrid');
  const sideDate = $('#selectedDayLabel');
  const eventList = $('#eventList');
  const totalCount = $('#totalCount');

  const modalWrap = $('#modalWrap');
  const modalBack = $('#modalBack');
  const eventForm = $('#eventForm');
  const deleteBtn = $('#deleteBtn');
  const cancelBtn = $('#cancelBtn');
  const evtTitle = $('#evtTitle');
  const evtDate = $('#evtDate');
  const evtTime = $('#evtTime');
  const evtDesc = $('#evtDesc');
  const evtColor = $('#evtColor');
  const evtId = $('#evtId');

  /*** Fetch events from API ***/
  async function fetchEventsFromAPI(){
    try {
      const res = await fetch(API_URL, { method: "POST" });
      if(!res.ok) throw new Error("Failed to fetch API");
      const data = await res.json();
      console.log("API events:", data);
      return data; // must be an array of events [{id, title, date, time, color, desc}]
    } catch(err){
      console.error("Error fetching API:", err);
      return [];
    }
  }

  /*** Event storage ***/
  async function loadEvents(){
    const local = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    const api = await fetchEventsFromAPI();
    return [...local, ...api]; // merge local + API events
  }

  function saveEvents(arr){ localStorage.setItem(STORAGE_KEY, JSON.stringify(arr)); }
  function addEvent(evt){ const arr = JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]'); arr.push(evt); saveEvents(arr); }
  function updateEvent(evt){ const arr = JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]').map(e=> e.id===evt.id ? evt : e); saveEvents(arr); }
  function deleteEvent(id){ const arr = JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]').filter(e=>e.id!==id); saveEvents(arr); }
  function clearAllEvents(){ localStorage.removeItem(STORAGE_KEY); }

  /*** Render calendar grid ***/
  async function renderCalendar(){
    grid.innerHTML = '';
    const year = viewDate.getFullYear();
    const month = viewDate.getMonth();
    monthLabel.textContent = formatMonthYear(viewDate);

    const firstOfMonth = new Date(year, month, 1);
    const startDayIndex = firstOfMonth.getDay();
    const startDate = new Date(year, month, 1 - startDayIndex);

    const events = await loadEvents();

    for(let i=0;i<42;i++){
      const cur = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate()+i);
      const iso = formatISODate(cur);
      const isOther = cur.getMonth() !== month;
      const isToday = iso === formatISODate(new Date());
      const el = document.createElement('div');
      el.className = 'day'+(isOther?' other-month':'')+(isToday?' today':'');
      el.tabIndex = 0;
      el.dataset.iso = iso;
      el.innerHTML = `<div class="date">${cur.getDate()}</div><div class="events"></div>`;

      el.addEventListener('click', e => { if(!e.target.closest('.event-pill')) openModalForDate(iso); });
      el.addEventListener('dblclick', ()=> openModalForDate(iso));
      el.addEventListener('keydown', ev=>{ if(ev.key==='Enter') openModalForDate(iso); });

      grid.appendChild(el);

      const evs = events.filter(x=>x.date===iso).sort((a,b)=> (a.time||'')>(b.time||'')?1:-1);
      const eventsWrap = el.querySelector('.events');
      evs.slice(0,3).forEach(ev=>{
        const pill = document.createElement('div');
        pill.className='event-pill';
        pill.title=(ev.time?ev.time+' — ':'')+ev.title+(ev.desc?'\n'+ev.desc:'');
        pill.dataset.id=ev.id;
        pill.innerHTML=`<span class="event-color" style="background:${ev.color}"></span><span style="overflow:hidden;text-overflow:ellipsis">${ev.time?ev.time+' ':''}${ev.title}</span>`;
        pill.addEventListener('click', e=>{ e.stopPropagation(); openEditEvent(ev.id); });
        eventsWrap.appendChild(pill);
      });
      if(evs.length>3){
        const more = document.createElement('div');
        more.className='small muted';
        more.style.marginTop='6px';
        more.textContent=`+ ${evs.length-3} more`;
        eventsWrap.appendChild(more);
      }
    }
    highlightSelectedDay();
    renderSidePanel();
  }

  function highlightSelectedDay(){
    qs('.day').forEach(d=>{
      d.style.boxShadow = (d.dataset.iso===selectedDateISO)?'inset 0 -2px 0 0 rgba(255,255,255,0.02)':'none';
    });
  }

  /*** Render side panel ***/
  async function renderSidePanel(){
    sideDate.textContent = friendlyDateISO(selectedDateISO);
    const evs = (await loadEvents()).filter(e=>e.date===selectedDateISO).sort((a,b)=>(a.time||'')>(b.time||'')?1:-1);
    totalCount.textContent = (await loadEvents()).length;
    eventList.innerHTML = '';
    if(evs.length===0){
      eventList.innerHTML='<div class="no-events">No events for this day.</div>';
      return;
    }
    evs.forEach(ev=>{
      const card = document.createElement('div');
      card.className='ev-card';
      card.innerHTML=`
      <div class="ev-left">
        <div class="event-color" style="background:${ev.color}"></div>
        <div>
          <div class="ev-title">${escapeHtml(ev.title)}</div>
          <div class="ev-time">${ev.time?ev.time+' • ':''}${ev.desc?ev.desc:''}</div>
        </div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button style="background:transparent;border:0;color:var(--muted);cursor:pointer" data-id="${ev.id}" class="openBtn">Open</button>
      </div>
      `;
      eventList.appendChild(card);
    });

    qs('.openBtn').forEach(b=>b.addEventListener('click', e=>openEditEvent(e.target.dataset.id)));
  }

  /*** Modal handling ***/
  function openModalForDate(iso){
    selectedDateISO=iso;
    highlightSelectedDay();
    evtDate.value=iso; evtTime.value=''; evtTitle.value=''; evtDesc.value=''; evtColor.value='#4f46e5'; evtId.value='';
    deleteBtn.style.display='none'; $('#modalTitle').textContent='Add event'; modalWrap.style.display='block';
    setTimeout(()=>evtTitle.focus(),50); renderSidePanel();
  }

  function openEditEvent(id){
    const ev = JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]').find(x=>x.id===id);
    if(!ev) return;
    selectedDateISO=ev.date; highlightSelectedDay();
    evtDate.value=ev.date; evtTime.value=ev.time||''; evtTitle.value=ev.title; evtDesc.value=ev.desc||''; evtColor.value=ev.color||'#4f46e5'; evtId.value=ev.id;
    $('#modalTitle').textContent='Edit event'; deleteBtn.style.display='inline-block'; modalWrap.style.display='block';
    setTimeout(()=>evtTitle.focus(),50); renderSidePanel();
  }

  function closeModal(){ modalWrap.style.display='none'; }

  cancelBtn.addEventListener('click', closeModal);
  modalBack.addEventListener('click', e=>{ if(e.target===modalBack) closeModal(); });

  eventForm.addEventListener('submit', e=>{
    e.preventDefault();
    const title=evtTitle.value.trim(); if(!title){evtTitle.focus(); return;}
    const date=evtDate.value; const time=evtTime.value||''; const desc=evtDesc.value.trim(); const color=evtColor.value; const idVal=evtId.value;
    if(idVal) updateEvent({id:idVal, title, date, time, desc, color});
    else addEvent({id:'ev_'+Date.now()+'_'+Math.random().toString(36).slice(2,8), title, date, time, desc, color});
    closeModal(); renderCalendar();
  });

  deleteBtn.addEventListener('click', ()=>{
    const idVal=evtId.value; if(!idVal) return;
    if(!confirm('Delete this event?')) return;
    deleteEvent(idVal); closeModal(); renderCalendar();
  });

  /*** Buttons ***/
  $('#addQuick').addEventListener('click', ()=>openModalForDate(selectedDateISO || formatISODate(new Date())));
  $('#selectedDayLabel').addEventListener('click', ()=>openModalForDate(selectedDateISO));
  $('#prevBtn').addEventListener('click', async ()=>{ viewDate=new Date(viewDate.getFullYear(),viewDate.getMonth()-1,1); await renderCalendar(); });
  $('#nextBtn').addEventListener('click', async ()=>{ viewDate=new Date(viewDate.getFullYear(),viewDate.getMonth()+1,1); await renderCalendar(); });
  $('#todayBtn').addEventListener('click', async ()=>{ viewDate=new Date(); selectedDateISO=formatISODate(new Date()); await renderCalendar(); });
  $('#clearBtn').addEventListener('click', ()=>{ if(confirm('Clear all events?')) { clearAllEvents(); renderCalendar(); }});
  $('#exportBtn').addEventListener('click', ()=>{
    const data = JSON.stringify(JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]'), null, 2);
    const blob = new Blob([data], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='calendar-events.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  });

  document.addEventListener('keydown', e=>{
    if(e.target.tagName==='INPUT'||e.target.tagName==='TEXTAREA') return;
    if(e.key==='n') $('#nextBtn').click();
    if(e.key==='p') $('#prevBtn').click();
    if(e.key==='t') $('#todayBtn').click();
    if(e.key==='a') $('#addQuick').click();
  });

  window.addEventListener('storage', e=>{ if(e.key===STORAGE_KEY) renderCalendar(); });

  /*** Initial render ***/
  (async ()=>{ await renderCalendar(); })();
})();
</script>
</body>
</html>
